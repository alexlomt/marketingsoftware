"use strict";exports.id=9730,exports.ids=[9730],exports.modules={9151:(t,e,a)=>{function n(t){return t.headers.get("x-user-id")}function o(t){return t.headers.get("x-organization-id")}a.d(e,{mk:()=>o,n5:()=>n}),a(8070),a(7439),a(5813)},5813:(t,e,a)=>{a.d(e,{Oe:()=>i,RA:()=>c,WX:()=>l,c_:()=>r});var n=a(6521),o=a(6082);a(8046);let s=process.env.JWT_SECRET||"your-secret-key";async function r(t){return(0,n.hash)(t,10)}async function i(t,e){return(0,n.compare)(t,e)}function c(t,e="7d"){return(0,o.sign)(t,s,{expiresIn:e})}function l(t){try{return(0,o.verify)(t,s)}catch(t){return null}}},8046:(t,e,a)=>{a.d(e,{db:()=>r});var n=a(5900),o=a(4107);let s=new n.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});s.on("connect",()=>{console.log("Database connection established")}),s.on("error",t=>{console.error("Unexpected database error:",t)});let r={async query(t,e=[]){let a=await s.connect();try{let n=Date.now(),o=await a.query(t,e),s=Date.now()-n;return s>100&&console.log("Slow query:",{text:t,duration:s,rows:o.rowCount}),o}catch(t){(0,o.dy)(t)}finally{a.release()}},async transaction(t){let e=await s.connect();try{await e.query("BEGIN");let a=await t(e);return await e.query("COMMIT"),a}catch(t){await e.query("ROLLBACK"),(0,o.dy)(t)}finally{e.release()}},async insert(t,e){let a=Object.keys(e),n=Object.values(e),o=a.map((t,e)=>`$${e+1}`).join(", "),s=a.join(", "),r=`
      INSERT INTO ${t} (${s})
      VALUES (${o})
      RETURNING *
    `;return(await this.query(r,n)).rows[0]},async update(t,e,a){let n=Object.keys(a),o=Object.values(a),s=n.map((t,e)=>`${t} = $${e+1}`).join(", "),r=`
      UPDATE ${t}
      SET ${s}, updated_at = CURRENT_TIMESTAMP
      WHERE id = $${n.length+1}
      RETURNING *
    `;return(await this.query(r,[...o,e])).rows[0]},async findWithPagination(t,e={},a={}){let{page:n=1,limit:o=20,orderBy:s="created_at",order:r="DESC",fields:i="*"}=a,c=Object.keys(e),l=Object.values(e),u="";c.length>0&&(u="WHERE "+c.map((t,e)=>null===l[e]?`${t} IS NULL`:`${t} = $${e+1}`).join(" AND "));let d=`
      SELECT COUNT(*) as total
      FROM ${t}
      ${u}
    `,y=`
      SELECT ${i}
      FROM ${t}
      ${u}
      ORDER BY ${s} ${r}
      LIMIT ${o} OFFSET ${(n-1)*o}
    `,[w,f]=await Promise.all([this.query(d,l),this.query(y,l)]),m=parseInt(w.rows[0].total);return{data:f.rows,pagination:{page:Number(n),limit:Number(o),total:m,pages:Math.ceil(m/o)}}},async end(){await s.end(),console.log("Database connection pool has ended")}}},4107:(t,e,a)=>{a.d(e,{dR:()=>o,dy:()=>s,p8:()=>n}),a(8070);class n extends Error{constructor(t){super(t),this.name="ValidationError",this.code="VALIDATION_ERROR"}}class o extends Error{constructor(t="Resource"){super(`${t} not found`),this.name="NotFoundError",this.code="NOT_FOUND"}}function s(t){if(console.error("Database error:",t),"23505"===t.code)throw new n("A record with this information already exists");if("23503"===t.code)throw new n("Referenced record does not exist");if("42P01"===t.code)throw Error("Database schema issue: Table does not exist");throw Error("Database operation failed")}},3182:(t,e,a)=>{a.d(e,{GK:()=>c,Tk:()=>i,cX:()=>s,p$:()=>r,rE:()=>o});var n=a(8046);async function o(t,e){let a=await (0,n.getDB)(),{first_name:o,last_name:r,email:i,phone:c,address:l,city:u,state:d,zip_code:y,country:w,status:f,source:m,custom_fields:E}=t,_=(0,n.generateId)();return await (0,n.insertRow)(a,"contacts",{id:_,organization_id:e,first_name:o,last_name:r,email:i||null,phone:c||null,address:l||null,city:u||null,state:d||null,zip_code:y||null,country:w||null,status:f||"lead",source:m||null,custom_fields:E?JSON.stringify(E):null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),s(_,e)}async function s(t,e){let a=await (0,n.getDB)(),o=await (0,n.getRow)(a,"SELECT * FROM contacts WHERE id = ? AND organization_id = ?",[t,e]);if(!o)throw Error("Contact not found");return o.custom_fields&&(o.custom_fields=JSON.parse(o.custom_fields)),o}async function r(t,e={}){let a=await (0,n.getDB)(),{limit:o=50,offset:s=0,search:r=null,status:i=null,source:c=null,sort_by:l="created_at",sort_dir:u="desc"}=e,d="SELECT * FROM contacts WHERE organization_id = ?",y=[t];if(r){d+=" AND (first_name LIKE ? OR last_name LIKE ? OR email LIKE ? OR phone LIKE ?)";let t=`%${r}%`;y.push(t,t,t,t)}return i&&(d+=" AND status = ?",y.push(i)),c&&(d+=" AND source = ?",y.push(c)),d+=` ORDER BY ${l} ${"asc"===u?"ASC":"DESC"} LIMIT ? OFFSET ?`,y.push(o,s),(await (0,n.getRows)(a,d,y)).map(t=>(t.custom_fields&&(t.custom_fields=JSON.parse(t.custom_fields)),t))}async function i(t,e,a){let o=await (0,n.getDB)(),r=await s(t,e),i={};r.custom_fields&&(i="string"==typeof r.custom_fields?JSON.parse(r.custom_fields):r.custom_fields);let c=a.custom_fields?{...i,...a.custom_fields}:i,l={first_name:void 0!==a.first_name?a.first_name:r.first_name,last_name:void 0!==a.last_name?a.last_name:r.last_name,email:void 0!==a.email?a.email:r.email,phone:void 0!==a.phone?a.phone:r.phone,address:void 0!==a.address?a.address:r.address,city:void 0!==a.city?a.city:r.city,state:void 0!==a.state?a.state:r.state,zip_code:void 0!==a.zip_code?a.zip_code:r.zip_code,country:void 0!==a.country?a.country:r.country,status:void 0!==a.status?a.status:r.status,source:void 0!==a.source?a.source:r.source,custom_fields:Object.keys(c).length>0?JSON.stringify(c):null,updated_at:new Date().toISOString()};return await (0,n.updateRow)(o,"contacts",l,"id = ? AND organization_id = ?",[t,e]),s(t,e)}async function c(t,e){let a=await (0,n.getDB)();await s(t,e),await (0,n.deleteRow)(a,"contacts","id = ? AND organization_id = ?",[t,e])}}};