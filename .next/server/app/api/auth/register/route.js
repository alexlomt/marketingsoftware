"use strict";(()=>{var e={};e.id=3002,e.ids=[3002],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},1704:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>m,originalPathname:()=>R,patchFetch:()=>f,requestAsyncStorage:()=>h,routeModule:()=>g,serverHooks:()=>E,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>y});var a={};r.r(a),r.d(a,{POST:()=>w});var n=r(5419),i=r(9108),o=r(9678),s=r(8070),u=r(8582),d=r(8046);async function l(e){let t=await (0,d.getDB)(),{name:r,industry:a,website:n,phone:i,address:o}=e,s=(0,d.generateId)();return await (0,d.insertRow)(t,"organizations",{id:s,name:r,industry:a||null,website:n||null,phone:i||null,address:o||null,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),c(s)}async function c(e){let t=await (0,d.getDB)(),r=await (0,d.getRow)(t,"SELECT * FROM organizations WHERE id = ?",[e]);if(!r)throw Error("Organization not found");return r}async function w(e){try{let{name:t,email:r,password:a,organization_name:n}=await e.json();if(!t||!r||!a||!n)return s.Z.json({error:"Missing required fields"},{status:400});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r))return s.Z.json({error:"Invalid email format"},{status:400});if(a.length<8)return s.Z.json({error:"Password must be at least 8 characters long"},{status:400});let i=await l({name:n}),o=await (0,u.r4)({name:t,email:r,password:a,role:"admin"},i.id);return s.Z.json({message:"Registration successful",user:{id:o.id,name:o.name,email:o.email,organization_id:o.organization_id,role:o.role},organization:{id:i.id,name:i.name}})}catch(e){if(console.error("Registration error:",e),"User with this email already exists"===e.message)return s.Z.json({error:"Email already in use"},{status:409});return s.Z.json({error:"Registration failed"},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:"app/api/auth/register/route"},resolvedPagePath:"/home/ubuntu/marketingsoftware/marketingsoftware-main/src/app/api/auth/register/route.js",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:p,serverHooks:E,headerHooks:m,staticGenerationBailout:y}=g,R="/api/auth/register/route";function f(){return(0,o.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:p})}},5813:(e,t,r)=>{r.d(t,{Oe:()=>s,RA:()=>u,WX:()=>d,c_:()=>o});var a=r(6521),n=r(6082);r(8046);let i=process.env.JWT_SECRET||"your-secret-key";async function o(e){return(0,a.hash)(e,10)}async function s(e,t){return(0,a.compare)(e,t)}function u(e,t="7d"){return(0,n.sign)(e,i,{expiresIn:t})}function d(e){try{return(0,n.verify)(e,i)}catch(e){return null}}},8046:(e,t,r)=>{r.d(t,{db:()=>o});var a=r(5900),n=r(4107);let i=new a.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});i.on("connect",()=>{console.log("Database connection established")}),i.on("error",e=>{console.error("Unexpected database error:",e)});let o={async query(e,t=[]){let r=await i.connect();try{let a=Date.now(),n=await r.query(e,t),i=Date.now()-a;return i>100&&console.log("Slow query:",{text:e,duration:i,rows:n.rowCount}),n}catch(e){(0,n.dy)(e)}finally{r.release()}},async transaction(e){let t=await i.connect();try{await t.query("BEGIN");let r=await e(t);return await t.query("COMMIT"),r}catch(e){await t.query("ROLLBACK"),(0,n.dy)(e)}finally{t.release()}},async insert(e,t){let r=Object.keys(t),a=Object.values(t),n=r.map((e,t)=>`$${t+1}`).join(", "),i=r.join(", "),o=`
      INSERT INTO ${e} (${i})
      VALUES (${n})
      RETURNING *
    `;return(await this.query(o,a)).rows[0]},async update(e,t,r){let a=Object.keys(r),n=Object.values(r),i=a.map((e,t)=>`${e} = $${t+1}`).join(", "),o=`
      UPDATE ${e}
      SET ${i}, updated_at = CURRENT_TIMESTAMP
      WHERE id = $${a.length+1}
      RETURNING *
    `;return(await this.query(o,[...n,t])).rows[0]},async findWithPagination(e,t={},r={}){let{page:a=1,limit:n=20,orderBy:i="created_at",order:o="DESC",fields:s="*"}=r,u=Object.keys(t),d=Object.values(t),l="";u.length>0&&(l="WHERE "+u.map((e,t)=>null===d[t]?`${e} IS NULL`:`${e} = $${t+1}`).join(" AND "));let c=`
      SELECT COUNT(*) as total
      FROM ${e}
      ${l}
    `,w=`
      SELECT ${s}
      FROM ${e}
      ${l}
      ORDER BY ${i} ${o}
      LIMIT ${n} OFFSET ${(a-1)*n}
    `,[g,h]=await Promise.all([this.query(c,d),this.query(w,d)]),p=parseInt(g.rows[0].total);return{data:h.rows,pagination:{page:Number(a),limit:Number(n),total:p,pages:Math.ceil(p/n)}}},async end(){await i.end(),console.log("Database connection pool has ended")}}},4107:(e,t,r)=>{r.d(t,{dR:()=>n,dy:()=>i,p8:()=>a}),r(8070);class a extends Error{constructor(e){super(e),this.name="ValidationError",this.code="VALIDATION_ERROR"}}class n extends Error{constructor(e="Resource"){super(`${e} not found`),this.name="NotFoundError",this.code="NOT_FOUND"}}function i(e){if(console.error("Database error:",e),"23505"===e.code)throw new a("A record with this information already exists");if("23503"===e.code)throw new a("Referenced record does not exist");if("42P01"===e.code)throw Error("Database schema issue: Table does not exist");throw Error("Database operation failed")}},8582:(e,t,r)=>{r.d(t,{GA:()=>s,So:()=>o,r4:()=>i});var a=r(8046),n=r(5813);async function i(e,t){let r=await (0,a.getDB)(),{name:i,email:o,password:s,role:u}=e;if(await (0,a.getRow)(r,"SELECT * FROM users WHERE email = ?",[o]))throw Error("User with this email already exists");let d=await (0,n.c_)(s),l=(0,a.generateId)();return await (0,a.insertRow)(r,"users",{id:l,organization_id:t,name:i,email:o,password_hash:d,role:u||"user",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),await (0,a.getRow)(r,"SELECT id, organization_id, name, email, role, created_at, updated_at FROM users WHERE id = ?",[l])}async function o(e,t){let r=await (0,a.getDB)(),i=await (0,a.getRow)(r,"SELECT * FROM users WHERE email = ?",[e]);if(!i||!await (0,n.Oe)(t,i.password_hash))throw Error("Invalid credentials");let o=(0,n.RA)({id:i.id,organization_id:i.organization_id,role:i.role});return{user:{id:i.id,organization_id:i.organization_id,name:i.name,email:i.email,role:i.role,created_at:i.created_at,updated_at:i.updated_at},token:o}}async function s(e){let t=await (0,a.getDB)(),r=await (0,a.getRow)(t,"SELECT id, organization_id, name, email, role, created_at, updated_at FROM users WHERE id = ?",[e]);if(!r)throw Error("User not found");return r}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,7145],()=>r(1704));module.exports=a})();