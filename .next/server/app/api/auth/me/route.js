"use strict";(()=>{var e={};e.id=8788,e.ids=[8788],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},8241:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>E,originalPathname:()=>g,patchFetch:()=>y,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>h,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>m});var a={};r.r(a),r.d(a,{GET:()=>c});var o=r(5419),n=r(9108),i=r(9678),s=r(8070),u=r(5813),d=r(8582);async function c(e){try{let t=e.cookies.get("auth_token")?.value;if(!t)return s.Z.json({error:"Authentication required"},{status:401});let r=(0,u.WX)(t);if(!r)return s.Z.json({error:"Invalid or expired token"},{status:401});let a=await (0,d.GA)(r.id);return s.Z.json({user:{id:a.id,name:a.name,email:a.email,organization_id:a.organization_id,role:a.role,created_at:a.created_at,updated_at:a.updated_at}})}catch(e){if(console.error("Get current user error:",e),"User not found"===e.message)return s.Z.json({error:"User not found"},{status:404});return s.Z.json({error:"Failed to get user information"},{status:500})}}let l=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/auth/me/route",pathname:"/api/auth/me",filename:"route",bundlePath:"app/api/auth/me/route"},resolvedPagePath:"/home/ubuntu/marketingsoftware/marketingsoftware-main/src/app/api/auth/me/route.js",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:w,serverHooks:h,headerHooks:E,staticGenerationBailout:m}=l,g="/api/auth/me/route";function y(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:w})}},5813:(e,t,r)=>{r.d(t,{Oe:()=>s,RA:()=>u,WX:()=>d,c_:()=>i});var a=r(6521),o=r(6082);r(8046);let n=process.env.JWT_SECRET||"your-secret-key";async function i(e){return(0,a.hash)(e,10)}async function s(e,t){return(0,a.compare)(e,t)}function u(e,t="7d"){return(0,o.sign)(e,n,{expiresIn:t})}function d(e){try{return(0,o.verify)(e,n)}catch(e){return null}}},8046:(e,t,r)=>{r.d(t,{db:()=>i});var a=r(5900),o=r(4107);let n=new a.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});n.on("connect",()=>{console.log("Database connection established")}),n.on("error",e=>{console.error("Unexpected database error:",e)});let i={async query(e,t=[]){let r=await n.connect();try{let a=Date.now(),o=await r.query(e,t),n=Date.now()-a;return n>100&&console.log("Slow query:",{text:e,duration:n,rows:o.rowCount}),o}catch(e){(0,o.dy)(e)}finally{r.release()}},async transaction(e){let t=await n.connect();try{await t.query("BEGIN");let r=await e(t);return await t.query("COMMIT"),r}catch(e){await t.query("ROLLBACK"),(0,o.dy)(e)}finally{t.release()}},async insert(e,t){let r=Object.keys(t),a=Object.values(t),o=r.map((e,t)=>`$${t+1}`).join(", "),n=r.join(", "),i=`
      INSERT INTO ${e} (${n})
      VALUES (${o})
      RETURNING *
    `;return(await this.query(i,a)).rows[0]},async update(e,t,r){let a=Object.keys(r),o=Object.values(r),n=a.map((e,t)=>`${e} = $${t+1}`).join(", "),i=`
      UPDATE ${e}
      SET ${n}, updated_at = CURRENT_TIMESTAMP
      WHERE id = $${a.length+1}
      RETURNING *
    `;return(await this.query(i,[...o,t])).rows[0]},async findWithPagination(e,t={},r={}){let{page:a=1,limit:o=20,orderBy:n="created_at",order:i="DESC",fields:s="*"}=r,u=Object.keys(t),d=Object.values(t),c="";u.length>0&&(c="WHERE "+u.map((e,t)=>null===d[t]?`${e} IS NULL`:`${e} = $${t+1}`).join(" AND "));let l=`
      SELECT COUNT(*) as total
      FROM ${e}
      ${c}
    `,p=`
      SELECT ${s}
      FROM ${e}
      ${c}
      ORDER BY ${n} ${i}
      LIMIT ${o} OFFSET ${(a-1)*o}
    `,[w,h]=await Promise.all([this.query(l,d),this.query(p,d)]),E=parseInt(w.rows[0].total);return{data:h.rows,pagination:{page:Number(a),limit:Number(o),total:E,pages:Math.ceil(E/o)}}},async end(){await n.end(),console.log("Database connection pool has ended")}}},4107:(e,t,r)=>{r.d(t,{dR:()=>o,dy:()=>n,p8:()=>a}),r(8070);class a extends Error{constructor(e){super(e),this.name="ValidationError",this.code="VALIDATION_ERROR"}}class o extends Error{constructor(e="Resource"){super(`${e} not found`),this.name="NotFoundError",this.code="NOT_FOUND"}}function n(e){if(console.error("Database error:",e),"23505"===e.code)throw new a("A record with this information already exists");if("23503"===e.code)throw new a("Referenced record does not exist");if("42P01"===e.code)throw Error("Database schema issue: Table does not exist");throw Error("Database operation failed")}},8582:(e,t,r)=>{r.d(t,{GA:()=>s,So:()=>i,r4:()=>n});var a=r(8046),o=r(5813);async function n(e,t){let r=await (0,a.getDB)(),{name:n,email:i,password:s,role:u}=e;if(await (0,a.getRow)(r,"SELECT * FROM users WHERE email = ?",[i]))throw Error("User with this email already exists");let d=await (0,o.c_)(s),c=(0,a.generateId)();return await (0,a.insertRow)(r,"users",{id:c,organization_id:t,name:n,email:i,password_hash:d,role:u||"user",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),await (0,a.getRow)(r,"SELECT id, organization_id, name, email, role, created_at, updated_at FROM users WHERE id = ?",[c])}async function i(e,t){let r=await (0,a.getDB)(),n=await (0,a.getRow)(r,"SELECT * FROM users WHERE email = ?",[e]);if(!n||!await (0,o.Oe)(t,n.password_hash))throw Error("Invalid credentials");let i=(0,o.RA)({id:n.id,organization_id:n.organization_id,role:n.role});return{user:{id:n.id,organization_id:n.organization_id,name:n.name,email:n.email,role:n.role,created_at:n.created_at,updated_at:n.updated_at},token:i}}async function s(e){let t=await (0,a.getDB)(),r=await (0,a.getRow)(t,"SELECT id, organization_id, name, email, role, created_at, updated_at FROM users WHERE id = ?",[e]);if(!r)throw Error("User not found");return r}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,7145],()=>r(8241));module.exports=a})();