"use strict";(()=>{var e={};e.id=9436,e.ids=[9436],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},7549:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>y,originalPathname:()=>f,patchFetch:()=>R,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>h,staticGenerationAsyncStorage:()=>w,staticGenerationBailout:()=>E});var a={};r.r(a),r.d(a,{POST:()=>l});var o=r(5419),s=r(9108),n=r(9678),i=r(8070),u=r(8046),c=r(5813);async function l(e){try{let{token:t,password:r}=await e.json();if(!t||!r)return i.Z.json({error:"Token and password are required"},{status:400});if(r.length<8)return i.Z.json({error:"Password must be at least 8 characters long"},{status:400});let a=await (0,u.getDB)(),o=await (0,u.getRow)(a,"SELECT * FROM users WHERE reset_token = ?",[t]);if(!o)return i.Z.json({error:"Invalid or expired reset token"},{status:400});let s=new Date(o.reset_token_expiry);if(new Date>s)return i.Z.json({error:"Reset token has expired"},{status:400});let n=await (0,c.c_)(r);return await (0,u.updateRow)(a,"users",{password_hash:n,reset_token:null,reset_token_expiry:null,updated_at:new Date().toISOString()},"id = ?",[o.id]),i.Z.json({message:"Password has been reset successfully"})}catch(e){return console.error("Password reset error:",e),i.Z.json({error:"Password reset failed"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/reset-password/route",pathname:"/api/auth/reset-password",filename:"route",bundlePath:"app/api/auth/reset-password/route"},resolvedPagePath:"/home/ubuntu/marketingsoftware/marketingsoftware-main/src/app/api/auth/reset-password/route.js",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:p,staticGenerationAsyncStorage:w,serverHooks:h,headerHooks:y,staticGenerationBailout:E}=d,f="/api/auth/reset-password/route";function R(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:w})}},5813:(e,t,r)=>{r.d(t,{Oe:()=>i,RA:()=>u,WX:()=>c,c_:()=>n});var a=r(6521),o=r(6082);r(8046);let s=process.env.JWT_SECRET||"your-secret-key";async function n(e){return(0,a.hash)(e,10)}async function i(e,t){return(0,a.compare)(e,t)}function u(e,t="7d"){return(0,o.sign)(e,s,{expiresIn:t})}function c(e){try{return(0,o.verify)(e,s)}catch(e){return null}}},8046:(e,t,r)=>{r.d(t,{db:()=>n});var a=r(5900),o=r(4107);let s=new a.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});s.on("connect",()=>{console.log("Database connection established")}),s.on("error",e=>{console.error("Unexpected database error:",e)});let n={async query(e,t=[]){let r=await s.connect();try{let a=Date.now(),o=await r.query(e,t),s=Date.now()-a;return s>100&&console.log("Slow query:",{text:e,duration:s,rows:o.rowCount}),o}catch(e){(0,o.dy)(e)}finally{r.release()}},async transaction(e){let t=await s.connect();try{await t.query("BEGIN");let r=await e(t);return await t.query("COMMIT"),r}catch(e){await t.query("ROLLBACK"),(0,o.dy)(e)}finally{t.release()}},async insert(e,t){let r=Object.keys(t),a=Object.values(t),o=r.map((e,t)=>`$${t+1}`).join(", "),s=r.join(", "),n=`
      INSERT INTO ${e} (${s})
      VALUES (${o})
      RETURNING *
    `;return(await this.query(n,a)).rows[0]},async update(e,t,r){let a=Object.keys(r),o=Object.values(r),s=a.map((e,t)=>`${e} = $${t+1}`).join(", "),n=`
      UPDATE ${e}
      SET ${s}, updated_at = CURRENT_TIMESTAMP
      WHERE id = $${a.length+1}
      RETURNING *
    `;return(await this.query(n,[...o,t])).rows[0]},async findWithPagination(e,t={},r={}){let{page:a=1,limit:o=20,orderBy:s="created_at",order:n="DESC",fields:i="*"}=r,u=Object.keys(t),c=Object.values(t),l="";u.length>0&&(l="WHERE "+u.map((e,t)=>null===c[t]?`${e} IS NULL`:`${e} = $${t+1}`).join(" AND "));let d=`
      SELECT COUNT(*) as total
      FROM ${e}
      ${l}
    `,p=`
      SELECT ${i}
      FROM ${e}
      ${l}
      ORDER BY ${s} ${n}
      LIMIT ${o} OFFSET ${(a-1)*o}
    `,[w,h]=await Promise.all([this.query(d,c),this.query(p,c)]),y=parseInt(w.rows[0].total);return{data:h.rows,pagination:{page:Number(a),limit:Number(o),total:y,pages:Math.ceil(y/o)}}},async end(){await s.end(),console.log("Database connection pool has ended")}}},4107:(e,t,r)=>{r.d(t,{dR:()=>o,dy:()=>s,p8:()=>a}),r(8070);class a extends Error{constructor(e){super(e),this.name="ValidationError",this.code="VALIDATION_ERROR"}}class o extends Error{constructor(e="Resource"){super(`${e} not found`),this.name="NotFoundError",this.code="NOT_FOUND"}}function s(e){if(console.error("Database error:",e),"23505"===e.code)throw new a("A record with this information already exists");if("23503"===e.code)throw new a("Referenced record does not exist");if("42P01"===e.code)throw Error("Database schema issue: Table does not exist");throw Error("Database operation failed")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[1638,6206,7145],()=>r(7549));module.exports=a})();