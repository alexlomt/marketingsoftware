"use strict";(()=>{var e={};e.id=8873,e.ids=[8873],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},5900:e=>{e.exports=require("pg")},4300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},2781:e=>{e.exports=require("stream")},3837:e=>{e.exports=require("util")},7569:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>h,originalPathname:()=>g,patchFetch:()=>m,requestAsyncStorage:()=>c,routeModule:()=>d,serverHooks:()=>w,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>E});var r={};a.r(r),a.d(r,{POST:()=>l});var o=a(5419),n=a(9108),i=a(9678),s=a(8070),u=a(8582);async function l(e){try{let{email:t,password:a}=await e.json();if(!t||!a)return s.Z.json({error:"Email and password are required"},{status:400});let{user:r,token:o}=await (0,u.So)(t,a),n=s.Z.json({message:"Login successful",user:{id:r.id,name:r.name,email:r.email,organization_id:r.organization_id,role:r.role}});return n.cookies.set({name:"auth_token",value:o,httpOnly:!0,secure:!0,sameSite:"strict",path:"/",maxAge:604800}),n}catch(e){if(console.error("Login error:",e),"Invalid credentials"===e.message)return s.Z.json({error:"Invalid email or password"},{status:401});return s.Z.json({error:"Login failed"},{status:500})}}let d=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"/home/ubuntu/marketingsoftware/marketingsoftware-main/src/app/api/auth/login/route.js",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:c,staticGenerationAsyncStorage:p,serverHooks:w,headerHooks:h,staticGenerationBailout:E}=d,g="/api/auth/login/route";function m(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:p})}},5813:(e,t,a)=>{a.d(t,{Oe:()=>s,RA:()=>u,WX:()=>l,c_:()=>i});var r=a(6521),o=a(6082);a(8046);let n=process.env.JWT_SECRET||"your-secret-key";async function i(e){return(0,r.hash)(e,10)}async function s(e,t){return(0,r.compare)(e,t)}function u(e,t="7d"){return(0,o.sign)(e,n,{expiresIn:t})}function l(e){try{return(0,o.verify)(e,n)}catch(e){return null}}},8046:(e,t,a)=>{a.d(t,{db:()=>i});var r=a(5900),o=a(4107);let n=new r.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1},max:20,idleTimeoutMillis:3e4,connectionTimeoutMillis:2e3});n.on("connect",()=>{console.log("Database connection established")}),n.on("error",e=>{console.error("Unexpected database error:",e)});let i={async query(e,t=[]){let a=await n.connect();try{let r=Date.now(),o=await a.query(e,t),n=Date.now()-r;return n>100&&console.log("Slow query:",{text:e,duration:n,rows:o.rowCount}),o}catch(e){(0,o.dy)(e)}finally{a.release()}},async transaction(e){let t=await n.connect();try{await t.query("BEGIN");let a=await e(t);return await t.query("COMMIT"),a}catch(e){await t.query("ROLLBACK"),(0,o.dy)(e)}finally{t.release()}},async insert(e,t){let a=Object.keys(t),r=Object.values(t),o=a.map((e,t)=>`$${t+1}`).join(", "),n=a.join(", "),i=`
      INSERT INTO ${e} (${n})
      VALUES (${o})
      RETURNING *
    `;return(await this.query(i,r)).rows[0]},async update(e,t,a){let r=Object.keys(a),o=Object.values(a),n=r.map((e,t)=>`${e} = $${t+1}`).join(", "),i=`
      UPDATE ${e}
      SET ${n}, updated_at = CURRENT_TIMESTAMP
      WHERE id = $${r.length+1}
      RETURNING *
    `;return(await this.query(i,[...o,t])).rows[0]},async findWithPagination(e,t={},a={}){let{page:r=1,limit:o=20,orderBy:n="created_at",order:i="DESC",fields:s="*"}=a,u=Object.keys(t),l=Object.values(t),d="";u.length>0&&(d="WHERE "+u.map((e,t)=>null===l[t]?`${e} IS NULL`:`${e} = $${t+1}`).join(" AND "));let c=`
      SELECT COUNT(*) as total
      FROM ${e}
      ${d}
    `,p=`
      SELECT ${s}
      FROM ${e}
      ${d}
      ORDER BY ${n} ${i}
      LIMIT ${o} OFFSET ${(r-1)*o}
    `,[w,h]=await Promise.all([this.query(c,l),this.query(p,l)]),E=parseInt(w.rows[0].total);return{data:h.rows,pagination:{page:Number(r),limit:Number(o),total:E,pages:Math.ceil(E/o)}}},async end(){await n.end(),console.log("Database connection pool has ended")}}},4107:(e,t,a)=>{a.d(t,{dR:()=>o,dy:()=>n,p8:()=>r}),a(8070);class r extends Error{constructor(e){super(e),this.name="ValidationError",this.code="VALIDATION_ERROR"}}class o extends Error{constructor(e="Resource"){super(`${e} not found`),this.name="NotFoundError",this.code="NOT_FOUND"}}function n(e){if(console.error("Database error:",e),"23505"===e.code)throw new r("A record with this information already exists");if("23503"===e.code)throw new r("Referenced record does not exist");if("42P01"===e.code)throw Error("Database schema issue: Table does not exist");throw Error("Database operation failed")}},8582:(e,t,a)=>{a.d(t,{GA:()=>s,So:()=>i,r4:()=>n});var r=a(8046),o=a(5813);async function n(e,t){let a=await (0,r.getDB)(),{name:n,email:i,password:s,role:u}=e;if(await (0,r.getRow)(a,"SELECT * FROM users WHERE email = ?",[i]))throw Error("User with this email already exists");let l=await (0,o.c_)(s),d=(0,r.generateId)();return await (0,r.insertRow)(a,"users",{id:d,organization_id:t,name:n,email:i,password_hash:l,role:u||"user",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),await (0,r.getRow)(a,"SELECT id, organization_id, name, email, role, created_at, updated_at FROM users WHERE id = ?",[d])}async function i(e,t){let a=await (0,r.getDB)(),n=await (0,r.getRow)(a,"SELECT * FROM users WHERE email = ?",[e]);if(!n||!await (0,o.Oe)(t,n.password_hash))throw Error("Invalid credentials");let i=(0,o.RA)({id:n.id,organization_id:n.organization_id,role:n.role});return{user:{id:n.id,organization_id:n.organization_id,name:n.name,email:n.email,role:n.role,created_at:n.created_at,updated_at:n.updated_at},token:i}}async function s(e){let t=await (0,r.getDB)(),a=await (0,r.getRow)(t,"SELECT id, organization_id, name, email, role, created_at, updated_at FROM users WHERE id = ?",[e]);if(!a)throw Error("User not found");return a}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[1638,6206,7145],()=>a(7569));module.exports=r})();